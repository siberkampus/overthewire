{{define "content"}}
<div class="machine-form-page">
    <!-- Header -->
    <div class="form-header">
        <div>
            <h2><i class="fas {{if .Machine.ID}}fa-edit{{else}}fa-plus-circle{{end}}"></i>
                {{if .Machine.ID}}Makine Düzenle{{else}}Yeni Makine Ekle{{end}}</h2>
            <p>{{if .Machine.ID}}Makine bilgilerini güncelleyin{{else}}Platforma yeni bir makine ekleyin{{end}}</p>
        </div>
        <a href="/admin/machines" class="btn-secondary">
            <i class="fas fa-arrow-left"></i> Geri Dön
        </a>
    </div>

    <!-- Form -->
    <form method="POST" action="/admin/api/machines{{if .Machine.ID}}/{{.Machine.ID}}{{end}}" 
          enctype="multipart/form-data" class="machine-form">
        
        <div class="form-grid">
            <!-- Sol Kolon -->
            <div class="form-left">
                <!-- Temel Bilgiler -->
                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fas fa-info-circle"></i> Temel Bilgiler
                    </h3>

                    <div class="form-group">
                        <label>Makine Adı <span class="required">*</span></label>
                        <input type="text" name="name" value="{{.Machine.Name}}" required 
                               placeholder="Örn: BlueSky, DarkNet, Metasploitable3">
                    </div>

                    <div class="form-group">
                        <label>Açıklama</label>
                        <textarea name="description" rows="4" 
                                  placeholder="Makine hakkında açıklama...">{{.Machine.Description}}</textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group half">
                            <label>Zorluk <span class="required">*</span></label>
                            <select name="difficulty" required>
                                <option value="">Seçiniz</option>
                                <option value="easy" {{if eq .Machine.Difficulty "easy"}}selected{{end}}>Kolay</option>
                                <option value="medium" {{if eq .Machine.Difficulty "medium"}}selected{{end}}>Orta</option>
                                <option value="hard" {{if eq .Machine.Difficulty "hard"}}selected{{end}}>Zor</option>
                                <option value="expert" {{if eq .Machine.Difficulty "expert"}}selected{{end}}>Uzman</option>
                            </select>
                        </div>

                        <div class="form-group half">
                            <label>Puan</label>
                            <input type="number" name="points_reward" value="{{.Machine.PointsReward}}" min="0" step="100">
                        </div>
                    </div>
                </div>

                <!-- Görsel ve Docker -->
                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fas fa-image"></i> Görsel & Docker
                    </h3>

                    <div class="form-group">
                        <label>Makine Görseli</label>
                        <div class="image-upload">
                            {{if .Machine.ImageURL}}
                            <img src="{{.Machine.ImageURL}}" alt="Preview" class="image-preview">
                            {{else}}
                            <div class="image-placeholder">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Görsel yüklemek için tıklayın</p>
                            </div>
                            {{end}}
                            <input type="file" name="image" accept="image/*" id="imageInput" style="display: none;">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Docker Image</label>
                        <input type="text" name="docker_image" value="{{.Machine.DockerImage}}" 
                               placeholder="Örn: ubuntu:20.04, metasploitframework/metasploit">
                    </div>

                    
                </div>
            </div>

            <!-- Sağ Kolon -->
            <div class="form-right">
                <!-- Yazar ve Durum -->
                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fas fa-cog"></i> Ayarlar
                    </h3>

                    <div class="form-group">
                        <label>Yazar / Oluşturan</label>
                        <input type="text" name="creator" value="{{.Machine.Creator}}" 
                               placeholder="Makineyi oluşturan kişi">
                    </div>

                    <div class="toggle-group">
                        <div class="toggle-item">
                            <span>Makine Aktif mi?</span>
                            <label class="switch">
                                <input type="checkbox" name="is_active" {{if .Machine.IsActive}}checked{{end}}>
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="toggle-item">
                            <span>Sadece VIP Kullanıcılar</span>
                            <label class="switch">
                                <input type="checkbox" name="is_vip_only" {{if .Machine.IsVIPOnly}}checked{{end}}>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- İstatistikler (Sadece düzenleme modunda) -->
                {{if .Machine.ID}}
                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fas fa-chart-bar"></i> İstatistikler
                    </h3>

                    <div class="stats-mini">
                        <div class="stat-mini-item">
                            <span class="stat-mini-value">{{.Machine.SolverCount}}</span>
                            <span class="stat-mini-label">Çözen Kişi</span>
                        </div>
                        <div class="stat-mini-item">
                            <span class="stat-mini-value">{{.Machine.TotalQuestions}}</span>
                            <span class="stat-mini-label">Toplam Soru</span>
                        </div>
                        <div class="stat-mini-item">
                            <span class="stat-mini-value">{{.Machine.QuestionSolved}}</span>
                            <span class="stat-mini-label">Çözülen Soru</span>
                        </div>
                    </div>

                    <div class="progress-stat">
                        <span>Çözülme Oranı</span>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{.Machine.SolvePercentage}}%"></div>
                        </div>
                        <span class="progress-value">{{.Machine.SolvePercentage}}%</span>
                    </div>
                </div>
                {{end}}
            </div>
        </div>

        <!-- Sorular Bölümü -->
        <div class="form-section questions-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-question-circle"></i> Makine Soruları
                </h3>
                <button type="button" class="btn-add-question" onclick="addQuestion()">
                    <i class="fas fa-plus"></i> Yeni Soru Ekle
                </button>
            </div>

            <div id="questions-container">
                {{range $index, $question := .Machine.Questions}}
                <div class="question-card" id="question-{{$question.ID}}">
                    <div class="question-header">
                        <span class="question-title">Soru {{add $index 1}}</span>
                        <button type="button" class="btn-remove-question" onclick="removeQuestion('{{$question.ID}}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="question-body">
                        <input type="hidden" name="question_id[]" value="{{$question.ID}}">
                        
                        <div class="form-group">
                            <label>Soru Başlığı</label>
                            <input type="text" name="question_title[]" value="{{$question.Title}}" required>
                        </div>

                        <div class="form-group">
                            <label>Soru Açıklaması</label>
                            <textarea name="question_description[]" rows="2">{{$question.Description}}</textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group half">
                                <label>Puan</label>
                                <input type="number" name="question_points[]" value="{{$question.PointsReward}}" min="0">
                            </div>
                            <div class="form-group half">
                                <label>Flag</label>
                                <input type="text" name="question_flag[]" value="" placeholder="Yeni flag girin">
                                <small>Mevcut flag korunacak, değiştirmek için doldurun</small>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group half">
                                <label>İpucu</label>
                                <input type="text" name="question_hint[]" value="{{$question.Hint}}">
                            </div>
                            <div class="form-group half">
                                <label>İpucu Maliyeti</label>
                                <input type="number" name="question_hint_cost[]" value="{{$question.HintCost}}" min="0">
                            </div>
                        </div>

                        <div class="toggle-item">
                            <span>Soru Aktif</span>
                            <label class="switch small">
                                <input type="checkbox" name="question_active[]" {{if $question.IsActive}}checked{{end}}>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                {{else}}
                <div class="empty-questions" id="emptyQuestions">
                    <i class="fas fa-question-circle"></i>
                    <p>Henüz soru eklenmemiş. Yeni soru eklemek için butona tıklayın.</p>
                </div>
                {{end}}
            </div>
        </div>

        <!-- Form Butonları -->
        <div class="form-actions">
            <button type="button" class="btn-secondary" onclick="history.back()">
                İptal
            </button>
            <button type="submit" class="btn-primary">
                <i class="fas fa-save"></i> 
                {{if .Machine.ID}}Değişiklikleri Kaydet{{else}}Makineyi Oluştur{{end}}
            </button>
        </div>
    </form>
</div>

<style>
    .machine-form-page {
        max-width: 1400px;
        margin: 0 auto;
    }

    .form-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .form-header h2 {
        font-family: 'Share Tech Mono', monospace;
        color: #00ff9d;
        margin-bottom: 0.3rem;
    }

    .form-header p {
        color: #6a7a8a;
    }

    .btn-secondary {
        padding: 0.8rem 1.5rem;
        background: transparent;
        border: 1px solid #2a3a4a;
        border-radius: 8px;
        color: #b0b0b0;
        text-decoration: none;
        transition: 0.3s;
    }

    .btn-secondary:hover {
        border-color: #00ff9d;
        color: #00ff9d;
    }

    .machine-form {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
    }

    .form-section {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid #2a3a4a;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .section-title {
        font-family: 'Share Tech Mono', monospace;
        color: #00ff9d;
        margin-bottom: 1.5rem;
        font-size: 1.1rem;
    }

    .section-title i {
        margin-right: 0.5rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #b0b0b0;
        font-size: 0.9rem;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
        width: 100%;
        padding: 0.8rem 1rem;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid #2a3a4a;
        border-radius: 5px;
        color: #e0e0e0;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
        outline: none;
        border-color: #00ff9d;
    }

    .form-group small {
        display: block;
        color: #6a7a8a;
        font-size: 0.7rem;
        margin-top: 0.3rem;
    }

    .form-row {
        display: flex;
        gap: 1rem;
    }

    .half {
        flex: 1;
    }

    .required {
        color: #ff5f56;
    }

    .image-upload {
        border: 2px dashed #2a3a4a;
        border-radius: 10px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: 0.3s;
    }

    .image-upload:hover {
        border-color: #00ff9d;
    }

    .image-preview {
        max-width: 100%;
        max-height: 200px;
        border-radius: 5px;
    }

    .image-placeholder {
        color: #6a7a8a;
    }

    .image-placeholder i {
        font-size: 3rem;
        margin-bottom: 1rem;
    }

    .toggle-group {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .toggle-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
    }

    .switch.small {
        width: 40px;
        height: 20px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #2a3a4a;
        transition: .3s;
        border-radius: 24px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .3s;
        border-radius: 50%;
    }

    .switch.small .slider:before {
        height: 14px;
        width: 14px;
        left: 3px;
        bottom: 3px;
    }

    input:checked + .slider {
        background-color: #00ff9d;
    }

    input:checked + .slider:before {
        transform: translateX(26px);
    }

    .switch.small input:checked + .slider:before {
        transform: translateX(20px);
    }

    .stats-mini {
        display: flex;
        justify-content: space-around;
        margin-bottom: 1.5rem;
    }

    .stat-mini-item {
        text-align: center;
    }

    .stat-mini-value {
        font-family: 'Share Tech Mono', monospace;
        font-size: 1.3rem;
        color: #00ff9d;
        display: block;
    }

    .stat-mini-label {
        font-size: 0.7rem;
        color: #6a7a8a;
    }

    .progress-stat {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .progress-stat .progress-bar {
        flex: 1;
        height: 6px;
    }

    .progress-value {
        font-family: 'Share Tech Mono', monospace;
        color: #00ff9d;
    }

    .questions-section {
        margin-top: 1rem;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .btn-add-question {
        padding: 0.5rem 1rem;
        background: transparent;
        border: 1px solid #00ff9d;
        border-radius: 5px;
        color: #00ff9d;
        cursor: pointer;
        transition: 0.3s;
    }

    .btn-add-question:hover {
        background: rgba(0, 255, 157, 0.1);
    }

    .question-card {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid #2a3a4a;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        overflow: hidden;
    }

    .question-header {
        background: rgba(0, 255, 157, 0.1);
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #2a3a4a;
    }

    .question-title {
        font-weight: 600;
        color: #00ff9d;
    }

    .btn-remove-question {
        width: 30px;
        height: 30px;
        background: transparent;
        border: 1px solid #ff5f56;
        border-radius: 5px;
        color: #ff5f56;
        cursor: pointer;
        transition: 0.3s;
    }

    .btn-remove-question:hover {
        background: #ff5f56;
        color: #fff;
    }

    .question-body {
        padding: 1rem;
    }

    .empty-questions {
        text-align: center;
        padding: 3rem;
        color: #6a7a8a;
    }

    .empty-questions i {
        font-size: 3rem;
        margin-bottom: 1rem;
    }

    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 2rem;
    }

    .btn-primary {
        padding: 1rem 2rem;
        background: linear-gradient(45deg, #00ff9d, #00b86e);
        border: none;
        border-radius: 8px;
        color: #0a0f0f;
        font-weight: 600;
        cursor: pointer;
        transition: 0.3s;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(0, 255, 157, 0.4);
    }

    @media (max-width: 1024px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    let questionCount = {{len .Machine.Questions}};

    function addQuestion() {
        questionCount++;
        const container = document.getElementById('questions-container');
        const emptyDiv = document.getElementById('emptyQuestions');
        if (emptyDiv) emptyDiv.style.display = 'none';

        const questionHtml = `
            <div class="question-card" id="question-new-${questionCount}">
                <div class="question-header">
                    <span class="question-title">Soru ${questionCount}</span>
                    <button type="button" class="btn-remove-question" onclick="removeQuestion('new-${questionCount}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="question-body">
                    <input type="hidden" name="question_id[]" value="new">
                    
                    <div class="form-group">
                        <label>Soru Başlığı</label>
                        <input type="text" name="question_title[]" required>
                    </div>

                    <div class="form-group">
                        <label>Soru Açıklaması</label>
                        <textarea name="question_description[]" rows="2"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group half">
                            <label>Puan</label>
                            <input type="number" name="question_points[]" value="100" min="0">
                        </div>
                        <div class="form-group half">
                            <label>Flag</label>
                            <input type="text" name="question_flag[]" placeholder="FLAG{...}" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group half">
                            <label>İpucu</label>
                            <input type="text" name="question_hint[]">
                        </div>
                        <div class="form-group half">
                            <label>İpucu Maliyeti</label>
                            <input type="number" name="question_hint_cost[]" value="0" min="0">
                        </div>
                    </div>

                    <div class="toggle-item">
                        <span>Soru Aktif</span>
                        <label class="switch small">
                            <input type="checkbox" name="question_active[]" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        `;

        container.insertAdjacentHTML('beforeend', questionHtml);
    }

    function removeQuestion(id) {
        if (confirm('Bu soruyu silmek istediğinize emin misiniz?')) {
            if (id.startsWith('new')) {
                document.getElementById(`question-${id}`).remove();
            } else {
                fetch(`/admin/api/questions/${id}`, { method: 'DELETE' })
                    .then(() => {
                        document.getElementById(`question-${id}`).remove();
                    });
            }
        }
    }

    document.querySelector('.image-upload').addEventListener('click', function() {
        document.getElementById('imageInput').click();
    });

    document.getElementById('imageInput').addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const uploadDiv = document.querySelector('.image-upload');
                uploadDiv.innerHTML = `<img src="${e.target.result}" class="image-preview">`;
            }
            reader.readAsDataURL(e.target.files[0]);
        }
    });
</script>
{{end}}